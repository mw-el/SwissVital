<!--
  This file is a multi-language booking form that automatically detects the site's language
  based on the URL’s first path segment (e.g. /de, /en, /fr, /it). It loads its translation
  values from external JSON translation files (de.json, en.json, fr.json, it.json, etc.). These
  translation files are generated by a separate script that converts a source spreadsheet into
  translation files segmented by spreadsheet name. For this form, the translations are retrieved
  from the "buchungsformular-standard" section of each JSON file.

  The form is divided into three steps:
    1. Email & Location
    2. Personal Information
    3. Appointment Details and Confirmation

  All text elements have data-i18n attributes so that they can be replaced by values from the
  translation files.

  To ensure that the form always displays the proper language—even if the navigation bar loses
  its active language highlight when scrolling—the detected language is stored in localStorage.
  This way, even if the language indicator in the navbar is removed during scrolling, the form
  will continue to load the correct translation file.
  
  Extensive comments are provided throughout this file to explain each major code segment,
  making the file easy to understand and maintain.
-->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">Buchungsformular</title>
  <link rel="stylesheet" href="path/to/bootstrap.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ---------------------------------------------
       CSS Styles for the booking form
    --------------------------------------------- */

    /* Container and layout settings */
    #multiStepForm { max-width: 600px; margin: 0 auto; }
    .success-message { max-width: 600px; margin: 0 auto; }
    .form-step { display: none; }
    .form-step.active { display: block; }
    .step-title { font-size: 1.5rem; font-weight: bold; text-align: center; }
    .button-container { margin-top: clamp(30px, 5vw, 50px); }
    .form-check-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
    .form-floating { width: 100%; }
    .d-none { display: none; }
    .tooltip-info { font-size: 0.8rem; color: #6c757d; margin-top: 0.25rem; }
    .list-group { border-color: transparent; }

    /* Styling form controls */
    .form-control, .form-select {
      font-size: 1.1rem;
      padding: 12px 14px;
      height: 50px;
    }

    /* Adjust checkbox appearance and alignment */
    .form-check-container {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .form-check-input {
      width: 1em;
      height: 1em;
      margin: 0 .2em .3em 0;
      vertical-align: bottom;
      background-color: #fff;
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      border: 1px solid rgba(0, 0, 0, 0.25);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Button styling */
    .btn-xl {
      font-size: 1.2rem;
      padding: 14px 20px;
      border-radius: 50px;
    }

    /* Spacing for form steps */
    .form-step {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

  <!--
    Multi-Step Booking Form:
    The form is divided into three steps:
      1. Email & Location
      2. Personal Information
      3. Appointment Details and Confirmation

    Each text element uses data-i18n attributes so that the text can be replaced by values
    from the corresponding translation file (from the "buchungsformular-standard" section).
  -->
  <form id="multiStepForm" name="buchung" method="POST" data-netlify="true" netlify-honeypot="bot-field">
    <input type="hidden" name="form-name" value="buchung">
    <p class="d-none">
      <label data-i18n="bot_field_label">Bitte nicht ausfüllen: <input name="bot-field"></label>
    </p>

    <!-- Step 1: Email & Location -->
    <div class="form-step active" id="step-1">
      <h3 class="text-center mb-4 step-title" data-i18n="step1_title">Schritt 1 von 3: E-Mail & Standort</h3>
      <div class="form-floating mb-3">
        <input class="form-control" id="email" type="email" name="email" data-i18n-placeholder="email_placeholder" placeholder="name@example.com" required>
        <label for="email" data-i18n="emailLabel">E-Mail-Adresse *</label>
      </div>
      <div class="form-floating mb-3">
        <select class="form-select" id="standort" name="standort" required>
          <option value="" data-i18n="locationOptionDefault">Bitte wählen</option>
          <option value="Zürich" data-i18n="location_Zurich">Zürich</option>
          <option value="Bern" data-i18n="location_Bern">Bern</option>
          <option value="Basel" data-i18n="location_Basel">Basel</option>
        </select>
        <label for="standort" data-i18n="locationLabel">Standort *</label>
      </div>
      <div class="form-check-container mb-3">
        <input class="form-check-input" type="checkbox" id="datenschutz1" name="datenschutz1" required>
        <label class="form-check-label" for="datenschutz1" data-i18n="privacyAgreement">Ich stimme der Datenverarbeitung zu.</label>
      </div>
      <div class="d-grid button-container">
        <button class="btn btn-primary btn-xl" type="button" onclick="nextStep(1)" data-i18n="nextButton">Weiter</button>
      </div>
    </div>

    <!-- Step 2: Personal Information -->
    <div class="form-step" id="step-2">
      <h3 class="text-center mb-4 step-title" data-i18n="step2_title">Schritt 2 von 3: Persönliche Angaben</h3>
      <div class="form-floating mb-3">
        <input class="form-control" id="vorname" type="text" name="vorname" data-i18n-placeholder="firstName_placeholder" placeholder="Vorname" required>
        <label for="vorname" data-i18n="firstName">Vorname *</label>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="nachname" type="text" name="nachname" data-i18n-placeholder="lastName_placeholder" placeholder="Nachname" required>
        <label for="nachname" data-i18n="lastName">Nachname *</label>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="geburtsjahr" type="text" name="geburtsjahr" data-i18n-placeholder="birthYear_placeholder" placeholder="Geburtsjahr" required>
        <label for="geburtsjahr" data-i18n="birthYear">Geburtsjahr *</label>
        <div class="tooltip-info" data-i18n="birthYearInfo">Bitte tragen Sie hier Ihr Geburtsjahr ein.</div>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="strasse" type="text" name="strasse" data-i18n-placeholder="street_placeholder" placeholder="Strasse" required>
        <label for="strasse" data-i18n="street">Strasse *</label>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="plz" type="text" name="plz" data-i18n-placeholder="postalCode_placeholder" placeholder="PLZ" required>
        <label for="plz" data-i18n="postalCode">PLZ *</label>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="ort" type="text" name="ort" data-i18n-placeholder="city_placeholder" placeholder="Ort" required>
        <label for="ort" data-i18n="city">Ort *</label>
      </div>
      <div class="form-floating mb-3">
        <input class="form-control" id="telefon" type="tel" name="telefon" data-i18n-placeholder="phone_placeholder" placeholder="Telefonnummer" required>
        <label for="telefon" data-i18n="phone">Telefon *</label>
      </div>
      <div class="d-flex justify-content-between button-container">
        <button class="btn btn-secondary btn-xl" type="button" onclick="prevStep(2)" data-i18n="prevButton">Zurück</button>
        <button class="btn btn-primary btn-xl" type="button" onclick="nextStep(2)" data-i18n="nextButton">Weiter</button>
      </div>
    </div>

    <!-- Step 3: Appointment Details and Confirmation -->
    <div class="form-step" id="step-3">
      <h3 class="text-center mb-4 step-title" data-i18n="step3_title">Schritt 3 von 3: Abschluss</h3>
      <div class="form-floating mb-3">
        <select class="form-select" id="untersuchung" name="untersuchung" required>
          <option value="" data-i18n="examination_default">Bitte auswählen</option>
          <option value="Produkt 1 - CHF 1970.-">Produkt 1 - CHF 1970.-</option>
          <option value="Produkt 2 - CHF 2350.-">Produkt 2 - CHF 2350.-</option>
          <option value="Produkt 3 - CHF 850.-">Produkt 3 - CHF 850.-</option>
        </select>
        <label for="untersuchung" data-i18n="examination">Untersuchung *</label>
      </div>
      <div class="form-floating mb-3">
        <select class="form-select" id="terminwunsch" name="terminwunsch" required>
          <option value="" data-i18n="appointmentPreference_default">Bitte auswählen</option>
          <option value="Dringend">Dringend</option>
          <option value="In den nächsten sechs Wochen">In den nächsten sechs Wochen</option>
          <option value="Bitte rufen Sie mich zur Terminvereinbarung an.">Bitte rufen Sie mich zur Terminvereinbarung an.</option>
        </select>
        <label for="terminwunsch" data-i18n="appointmentPreference">Terminwunsch *</label>
      </div>
      <div class="form-check-container mb-3">
        <input class="form-check-input" type="checkbox" id="agb" name="agb" required>
        <label class="form-check-label" for="agb" data-i18n="termsAgreement">Ich stimme den <a href="/agb">AGB</a> zu.</label>
      </div>
      <div class="form-check-container mb-3">
        <input class="form-check-input" type="checkbox" id="datenschutz" name="datenschutz" required>
        <label class="form-check-label" for="datenschutz" data-i18n="privacyPolicyAgreement">Ich stimme der <a href="/privacy">Datenschutzerklärung</a> zu.</label>
      </div>
      <div class="d-flex justify-content-between button-container">
        <button class="btn btn-secondary btn-xl" type="button" onclick="prevStep(3)" data-i18n="prevButton">Zurück</button>
        <button class="btn btn-primary btn-xl" id="submitButton" type="submit" data-i18n="submitButton">Termin buchen</button>
      </div>
    </div>
  </form>

  <!--
    Success Message:
    This section displays a confirmation message and a summary of the submitted data after
    successful form submission.
  -->
  <div id="successMessage" class="card shadow-sm p-4 mt-4 text-center d-none success-message">
    <h3 class="text-success mb-3">
      <i class="material-icons">check_circle</i>
      <span data-i18n="successMessageTitle">Vielen Dank für Ihre Anmeldung!</span>
    </h3>
    <p class="mb-3"><strong data-i18n="successMessageIntro">Sie haben uns das Folgende mitgeteilt:</strong></p>
    <div class="text-start" id="summaryContent"></div>
    <hr>
    <p class="lead" id="emailConfirmation" class="mt-3"></p>
  </div>

  <script>
    // ---------------------------------------------
    // Phone Number Formatting and Validation Segment
    // ---------------------------------------------
    // These helper functions format and validate the phone number input.
    function formatPhoneNumber(number) {
      let digits = number.replace(/\D/g, '');
      // If the number is a Swiss number (10 digits, starting with "0"),
      // format it as "000 000 00 00".
      if (digits.length === 10 && digits.startsWith("0")) {
        return digits.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, "$1 $2 $3 $4");
      }
      return number;
    }

    function validatePhoneNumber(number) {
      let digits = number.replace(/\D/g, '');
      return (digits.length === 10 && digits.startsWith("0"));
    }

    // Attach an event listener to validate and format the phone number when the input loses focus.
    document.getElementById("telefon").addEventListener("blur", function() {
      let formatted = formatPhoneNumber(this.value);
      if (!validatePhoneNumber(formatted)) {
        alert("Bitte geben Sie eine gültige Telefonnummer mit 10 Ziffern ein.");
        this.value = "";
      } else {
        this.value = formatted;
      }
    });

    // ---------------------------------------------
    // Step Navigation Functions Segment
    // ---------------------------------------------
    // These functions manage navigation between the multi-step form sections.
    function nextStep(currentStep) {
      document.getElementById("step-" + currentStep).classList.remove("active");
      document.getElementById("step-" + (currentStep + 1)).classList.add("active");
    }

    function prevStep(currentStep) {
      document.getElementById("step-" + currentStep).classList.remove("active");
      document.getElementById("step-" + (currentStep - 1)).classList.add("active");
    }

    // ---------------------------------------------
    // Form Submission Segment
    // ---------------------------------------------
    // This segment handles form submission, compiles the data, shows a summary, and sends
    // the data to a server-side endpoint.
    document.getElementById("multiStepForm").addEventListener("submit", function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const formObject = Object.fromEntries(formData.entries());
      formObject.telefon = formatPhoneNumber(formObject.telefon);

      // Build a summary of the submitted data.
      let summaryHtml = `<ul class="list-group">
          <li class="list-group-item"><strong data-i18n="firstName">Vorname:</strong> ${formObject.vorname}</li>
          <li class="list-group-item"><strong data-i18n="lastName">Nachname:</strong> ${formObject.nachname}</li>
          <li class="list-group-item"><strong data-i18n="birthYear">Geburtsjahr:</strong> ${formObject.geburtsjahr}</li>
          <li class="list-group-item"><strong data-i18n="street">Strasse:</strong> ${formObject.strasse}</li>
          <li class="list-group-item"><strong data-i18n="postalCode">PLZ:</strong> ${formObject.plz}</li>
          <li class="list-group-item"><strong data-i18n="city">Ort:</strong> ${formObject.ort}</li>
          <li class="list-group-item"><strong data-i18n="emailLabel">E-Mail:</strong> ${formObject.email}</li>
          <li class="list-group-item"><strong data-i18n="phone">Telefon:</strong> ${formObject.telefon}</li>
          <li class="list-group-item"><strong data-i18n="locationLabel">Gewählter Praxis-Standort:</strong> ${formObject.standort}</li>`;
      
      if (formObject.terminwunsch) {
        summaryHtml += `<li class="list-group-item"><strong data-i18n="appointmentPreference">Terminwunsch:</strong> ${formObject.terminwunsch}</li>`;
      }
      if (formObject.untersuchung) {
        summaryHtml += `<li class="list-group-item"><strong data-i18n="examination">Untersuchung:</strong> ${formObject.untersuchung}</li>`;
      }
      
      summaryHtml += `</ul>`;
      document.getElementById("summaryContent").innerHTML = summaryHtml;
      document.getElementById("emailConfirmation").textContent =
        translations["emailConfirmation"] + " " + (formObject.email || "");
      document.getElementById("multiStepForm").classList.add("d-none");
      document.getElementById("successMessage").classList.remove("d-none");

      // Send the form data to the server (example using Netlify Functions).
      fetch('/.netlify/functions/sendConfirmation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formObject)
      });
    });

    // ---------------------------------------------
    // Multi-Language Translation Functions Segment
    // ---------------------------------------------
    // This segment loads translation data from external JSON files based on the detected language.
    // The translation files (e.g. de.json, en.json, etc.) are generated by a script that converts a
    // source spreadsheet into segmented translation files. This form retrieves its translations from the
    // "buchungsformular-standard" section.
    let translations = {};
    let currentLang = 'de'; // Default language, will be updated upon detection.

    async function loadTranslations(lang) {
      try {
        // Fetch the translation file corresponding to the detected language.
        const response = await fetch(`/i18n/${lang}.json`);
        const data = await response.json();
        // Extract the "buchungsformular-standard" section for this form.
        translations = data["buchungsformular-standard"] || {};
        currentLang = lang;
        applyTranslations();
      } catch (error) {
        console.error("Translation loading failed", error);
      }
    }

    function applyTranslations() {
      // Apply translations to all elements with a data-i18n attribute.
      document.querySelectorAll("[data-i18n]").forEach(element => {
        const key = element.getAttribute("data-i18n");
        if (translations[key]) {
          element.innerHTML = translations[key];
        }
      });
      // Apply translations to all elements with a data-i18n-placeholder attribute.
      document.querySelectorAll("[data-i18n-placeholder]").forEach(element => {
        const key = element.getAttribute("data-i18n-placeholder");
        if (translations[key]) {
          element.setAttribute("placeholder", translations[key]);
        }
      });
    }

    // ---------------------------------------------
    // Automatic Language Detection Segment
    // ---------------------------------------------
    // This segment automatically detects the site's language by examining the URL's first path segment.
    // For example, if the URL is "/de/...", "/en/...", "/fr/...", or "/it/...", the form will load the 
    // corresponding translation file.
    //
    // To ensure that the detected language is preserved even if the navigation bar loses its active highlight
    // during scrolling, the language is stored in localStorage. If a language has already been stored,
    // it will be used instead of re-detecting from the URL.
    document.addEventListener("DOMContentLoaded", () => {
      let detectedLang = localStorage.getItem("siteLang");
      if (!detectedLang) {
        const pathSegments = window.location.pathname.split('/').filter(segment => segment);
        const supportedLangs = ['de', 'en', 'fr', 'it'];
        detectedLang = (pathSegments.length > 0 && supportedLangs.includes(pathSegments[0].toLowerCase()))
                     ? pathSegments[0].toLowerCase() : 'de';
        localStorage.setItem("siteLang", detectedLang);
      }
      loadTranslations(detectedLang);
    });
  </script>

</body>
</html>
